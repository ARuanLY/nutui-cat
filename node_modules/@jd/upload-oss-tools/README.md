# jdoss 快速上传、下载插件

> 本插件 提供三种使用方法（GUI命令使用、WebPack挂载、NodeJs 脚本），根据需求不同可自行选择，支持推送到不同的平台（中国、印尼、泰国、测试）

> 如果是团队使用，建议统一管理 access secret 方便后期资源维护成本

> 使用前请先到 http://oss.jd.com/ 申请应用 access key 、 secret key


### 安装/更新

1. 安装
``` bash
jnpm install @jd/upload-oss-tools -g
```

2. 更新安装包
``` bash
jnpm update @jd/upload-oss-tools -g
```

3. 上传文件规则提示

```html
1、bucket 空间名称规则
   仅能由小写字母、数字、点号(.)、中划线(-) 组成

2、文件名规则
   a、只能由字母、数字、下划线（_）、中划线(-)、中文、目录分隔符（/）以及点号(.) 组成
   b、长度必须在 1-100 之间
   c、不能以"/"开头,不能包含连续的
```

4. OSS 空间说明

![](https://img14.360buyimg.com/imagetools/jfs/t1/122904/38/7562/51891/5f15403fE1aeb4363/d047b18602efc5b2.png)

![](https://img14.360buyimg.com/imagetools/jfs/t1/149109/1/3290/41482/5f15403fE5a030d6f/4a4e630f8b40328d.png)

5. 使用样例

![](https://img11.360buyimg.com/imagetools/jfs/t1/117605/6/15878/312175/5f439892E825c8f4b/4eaf8c53bd5a2f8e.gif)


### 注意事项

1. 内网上传

使用内网（storage.jd.local）上传的时候，需要将配置项 https 关掉，设置成 false，否则会上传失败。

### 方式一 命令 GUI 使用方法

##### 1. 命令行输入并选择对应命令
``` bash
jdoss
```

![](https://img14.360buyimg.com/imagetools/jfs/t1/148337/39/4434/165387/5f295da6E024e38d1/79ad0dad7e4d9258.png)

##### 2. 首次使用需要配置上传空间的信息，选择新增上传列表，选择新增之后，输入远程 oss 空间名称及文件夹名称（非首次忽略）

![](https://img11.360buyimg.com/imagetools/jfs/t1/111145/10/12747/7939/5f1540a5Eb795e88b/c16b8f776a5284a7.png)


##### 3. 配置上传文件的本地绝对路径（非首次忽略）

以 build 文件夹路径为例配置：我们先执行 build 命令，打包出一个 build 文件夹，找到此 build 的路径，并配置在输出命令之后。

Windows：可直接找到对应文件夹，复制文件路径

Linux：在对应目录下，执行命令 pwd，复制文件路径

![](https://img14.360buyimg.com/imagetools/jfs/t1/136166/5/4878/16830/5f1542d5E0964f793/8ead59a28befffbf.png)


##### 4. 开始上传

上述信息配置完成后，执行 jdoss 开始上传，选择上传文件，命令会列出之前的配置上传路径和管理目录，选择对应的上传路径或者其他操作

![](https://img11.360buyimg.com/imagetools/jfs/t1/116312/26/12813/33620/5f154f08Ea91359a8/ccf869965a3f78fa.png)

##### 5. 上传成功

![](https://img12.360buyimg.com/imagetools/jfs/t1/124106/32/7587/87912/5f154f4cE6c4dae81/fb16b46c5743a4bf.png)



### 方式二 NodeJs 脚本触发

> 重要说明: 服务器挂载执行时，site 值应设置 sotrage.jd.local 进行对应配置

> 新建 upload.js 文件,写入下面对应脚本

``` javascript 

const path = require('path');
const UploadOssPlugin = require('@jd/upload-oss-tools');
// 初始化上传应用
let _ploadOssPlugin= new UploadOssPlugin({
    localFullPath: path.resolve(__dirname, "./dist/"),// 被上传的本地绝对路径，自行配置
    access: "",// http://oss.jd.com/user/glist 生成的 access key
    secret: "",// http://oss.jd.com/user/glist 生成的 secret key
    site:"",// 远程 oss 路径 非必填 默认 storage.jd.local 可选(中国:storage.jd.local 印尼:storage-local.jd.id 泰国:storage.jd.th.local 测试:test.storage.jd.com)
    cover: true,// 是否覆盖远程空间文件 默认true
    printCdnFile: false,// 是否手动刷新cdn文件 默认false
    bucket: "",// 空间名字 仅能由小写字母、数字、点号(.)、中划线(-)组成
    folder: "",// 空间文件夹名称 非必填
    ignoreRegexp: "",// 排除的文件规则 正则字符串，匹配到的文件和文件夹都会忽略
    uploadStart: function(files) {},// 文件开始上传回调函数，返回文件列表参数
    uploadProgress: function(progress) {},// 文件上传过程回调函数，返回文件上传进度
    uploadEnd: function(res) {},// 文件上传完毕回调函数，返回 {上传文件数组、上传文件的总数，成功数量，失败数量，未上传数量
    // 下载oss空间 options参数，使用下下载功能时必填
    downloadOptions:[
        {
            bucket: "", // 空间名字 仅能由小写字母、数字、点号(.)、中划线(-)组成
            folder: "",// 空间文件夹名称 非必填
            downloadLocalFullPath:"", // 本地存储绝对路径
            remoteFolder:true, //是否映射远程绝对路径,默认 true
            downloadStart: function(files) {},// 文件开始下载回调函数，返回文件列表参数
            downloadProgress: function(progress) {},// 文件下载过程回调函数，返回文件下载进度
            downloadEnd: function(res) {},// 文件下载完毕回调函数，返回 {下载文件数组、下载文件的总数，成功数量，失败数量}
        }
    ]
});
// 执行上传
_ploadOssPlugin.upload();
// 上传配置除了在构造函数中设置，也可以在调用upload方法时入参，注：传参优先级大于初始化配置项
// _ploadOssPlugin.upload([{
//     localFullPath: path.resolve(__dirname, "./dist/"),// 被上传的本地绝对路径，自行配置
//     cover: true,// 是否覆盖远程空间文件 默认true“
//     printCdnFile: false,// 是否手动刷新cdn文件 默认false
//     bucket: "",// 空间名字 仅能由小写字母、数字、点号(.)、中划线(-)组成
//     folder: "",// 空间文件夹名称 非必填
//     ignoreRegexp: "",// 排除的文件规则 正则字符串，匹配到的文件和文件夹都会忽略
//     uploadStart: function(files) {},// 文件开始上传回调函数，返回文件列表参数
//     uploadProgress: function(progress) {},// 文件上传过程回调函数，返回文件上传进度
//     uploadEnd: function(res) {},// 文件上传完毕回调函数，返回 {上传文件数组、上传文件的总数，成功数量，失败数量，未上传数量
// }]);


// 执行下载，参数非必传，默认读取初始化应用 downloadOptions 选项， 注：传参优先级大于初始化配置项
// _ploadOssPlugin.download([{
//     bucket: "", // 空间名字 仅能由小写字母、数字、点号(.)、中划线(-)组成
//     folder: "",// 空间文件夹名称 非必填
//     downloadLocalFullPath:"", // 本地存储绝对路径
//     remoteFolder:true, //是否映射远程绝对路径,默认 true
//     downloadStart: function(files) {},// 文件开始下载回调函数，返回文件列表参数
//     downloadProgress: function(progress) {},// 文件下载过程回调函数，返回文件下载进度
//     downloadEnd: function(res) {},// 文件下载完毕回调函数，返回 {下载文件数组、下载文件的总数，成功数量，失败数量}
// }]);

```
> 执行命令

``` bash
node upload.js
```

### 方式三 WebPack 插件 使用方法

> 重要说明: 服务器挂载执行时，site 值应设置 sotrage.jd.local 进行对应配置

``` javascript

const path = require('path');
const WebPackUploadOssPlugin = require('@jd/upload-oss-tools');

new WebPackUploadOssPlugin({
    localFullPath: path.resolve(__dirname, "./dist/"),// 被上传的本地绝对路径，自行配置
    access: "",// http://oss.jd.com/user/glist 生成的 access key
    secret: "",// http://oss.jd.com/user/glist 生成的 secret key
    site:"",// 远程 oss 路径 非必填 默认 storage.jd.local 可选(中国:storage.jd.local 印尼:storage-local.jd.id 泰国:storage.jd.th.local 测试:test.storage.jd.com)
    cover: true,// 是否覆盖远程空间文件 默认true
    printCdnFile: false,// 是否手动刷新cdn文件 默认false
    bucket: "",// 空间名字 仅能由小写字母、数字、点号(.)、中划线(-)组成
    folder: "",// 空间文件夹名称 非必填
    ignoreRegexp: "",// 排除的文件规则 正则字符串，匹配到的文件和文件夹都会忽略
    uploadStart: function(files) {},// 文件开始上传回调函数，返回文件列表参数
    uploadProgress: function(progress) {},// 文件上传过程回调函数，返回文件上传进度
    uploadEnd: function(res) {}// 文件上传完毕回调函数，返回 {上传文件数组、上传文件的总数，成功数量，失败数量，未上传数量}
}), 

```

> VueCli3 以上版本使用

``` javascript
// 在vue.config.js 中 chainWebpack 中按照下面方式进行使用
chainWebpack: config => {
       if (process.env.NODE_ENV === "production") {
            config
                .plugin('upload')
                .use(new WebPackUploadOssPlugin({
                    localFullPath: path.resolve(__dirname, "./dist/"),// 被上传的本地绝对路径，自行配置
                    access: "xxx",// http://oss.jd.com/user/glist 生成的 access key
                    secret: "xxx",// http://oss.jd.com/user/glist 生成的 secret key
                    site: "",// 远程 oss 路径 非必填 默认 storage.jd.local 可选(中国:storage.jd.local 印尼:storage-local.jd.id 泰国:storage.jd.th.local 测试:test.storage.jd.com)
                    cover: true,// 是否覆盖远程空间文件 默认true
                    printCdnFile: false,// 是否手动刷新cdn文件 默认false
                    bucket: "xxx",// 空间名字 仅能由小写字母、数字、点号(.)、中划线(-)组成
                    folder: "",// 空间文件夹名称 非必填
                    ignoreRegexp: "",// 排除的文件规则 正则字符串，匹配到的文件和文件夹都会忽略
                    uploadStart: function(files) {},// 文件开始上传回调函数，返回文件列表参数
                    uploadProgress: function(progress) {},// 文件上传过程回调函数，返回文件上传进度
                    uploadEnd: function(res) {}// 文件上传完毕回调函数，返回 {上传文件数组、上传文件的总数，成功数量，失败数量，未上传数量}
                }));
        }
}

```

### changelog

#### 1.1.19、20

    * 上传 upload函数，支持多个上传选项传入 upload([option1,2,3])  @mayintao3
#### 1.1.18

    * 下载功能 新增钩子函数（downloadStart、downloadProgress、downloadEnd） @zhuzhida
#### 1.1.16、17

    * 修复文件上传时，无法忽略规则匹配到的文件问题 @yumingming11

#### 1.1.15

    * 下载功能 新增参数 remoteFolder 自定义映射远程绝对路径 @zhuzhida
#### 1.1.14

    * 优化上传下载，执行队列逻辑  @zhuzhida
    * nodejs使用方式，新增下载函数   @zhuzhida

#### 1.1.11

    * 修复上传时文件的进度回调问题 @yumingming11
    * 新增校验文件上传域名 @yumingming11
    * 应安全要求封禁从 *.jd.com 上传文件，改用 *.jd.local，同时屏蔽使用 https @yumingming11

#### 1.1.10

    * 修复 localFullPath 本地路径是文件时，无法上传问题
    * 关闭 sourceMap

#### 1.1.9

    * 新增上传开始回调函数
    * 新增上传过程回调函数
    * 新增上传完成回调函数
    * 优化文件上传功能
    * 优化文件中的下载链接

#### 1.1.8

    * 新增 cdn 缓存文件下载功能

#### 1.1.7

    * 支持批量下载功能 （命令行模式）
    * 修复上传时空间不存在创建问题

#### 1.1.5

    * 优化文档内容，增加vue-cli3中webapack的使用方法
    * flolder 文件夹名称容错处理

#### 1.1.2

    * 修复上传bug
    * 增加清空本地配置信息功能

#### 1.1.1

    * 支持https选项、部分代码重构抽离



### 问题反馈

- nodejs jdoss 上传插件 沟通群 【咚咚群号】:85370482
- 如果您在使用过程中遇到什么问题，可通过沟通群及时联系我们

